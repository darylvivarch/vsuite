<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vivarch · URL Shortening Service</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="preload" as="image" href="logo.png" />
  <style>
    :root{
      --accent:#149bb2;
      --secondary:#cdd2d4;
      --text:#4a4a4a;
      --white:#fafeff;
      --radius:22px;
      --header-h:150px;
      --dock-h:75px;
      --ring: rgba(20,155,178,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(20,155,178,.18), transparent 60%),
        radial-gradient(1200px 800px at 110% 110%, rgba(20,155,178,.12), transparent 60%),
        var(--secondary);
    }

    /* Header (flat, 150px, logo only) */
    .header{
      position:sticky; top:0; z-index:50; height:var(--header-h);
      display:flex; align-items:center; justify-content:center; background: var(--white);
      border-bottom:1px solid #ddd;
    }
    .header img{height:100%; width:auto; max-height:120px;}

    /* Title identical to index */
    .hub-title{
      text-align:center; margin:20px 0; font-size:28px; font-weight:700; color:var(--accent);
    }

    /* ===== Locked Stage (identical to index.html) ===== */
    .container{
      min-height:calc(100dvh - var(--header-h) - var(--dock-h));
      display:grid; place-items:center;
      padding:10px 16px 120px;
    }
    .stage{
      width:min(1200px, 94vw);
      min-height:min(600px, 62vh);
      background:linear-gradient(180deg, rgba(250,254,255,.92), rgba(250,254,255,.72));
      border:1px solid rgba(255,255,255,.65);
      border-radius:var(--radius);
      backdrop-filter: blur(8px) saturate(140%);
      -webkit-backdrop-filter: blur(8px) saturate(140%);
      padding:28px;
      display:flex; align-items:center; justify-content:center; text-align:center;
      overflow:hidden;
    }
    /* ================================================ */

    /* Card/content */
    .wrap{max-width:820px; margin:0 auto; width:100%;}
    .card{
      background:#fafeff;
      border-radius:var(--radius);
      padding:24px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 12px 30px rgba(0,0,0,0.06);
      text-align:left;
    }
    h1{margin:0 0 16px; text-align:center; font-weight:700; color:var(--text); font-size:26px;}

    .field{display:flex; flex-direction:column; gap:8px; margin-bottom:12px}
    .label{font-size:12px; color:#5a6a6f}
    .label.flex{display:flex; align-items:center; gap:8px; position:relative}
    input[type="text"], input[type="password"], select{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(0,0,0,.08);
      background:#f6f8f9; color:var(--text); outline:none; transition:border .2s, box-shadow .2s
    }
    input:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 4px var(--ring)}
    .invalid{border-color:#e53935 !important; box-shadow:0 0 0 4px rgba(229,57,53,.15) !important;}

    .help{
      width:20px; height:20px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:50%; font-weight:700; font-size:12px; color:#0c2f35;
      background:rgba(20,155,178,.15); border:1px solid rgba(20,155,178,.35);
      cursor:default; user-select:none;
    }
    .tip{
      display:none; position:absolute; left:0; top:calc(100% + 8px); z-index:15;
      background:#fff; color:#263238; border:1px solid #e5e7eb; border-radius:12px;
      padding:12px 14px; max-width:560px; box-shadow:0 10px 28px rgba(0,0,0,.08);
      line-height:1.55;
    }
    .label.flex .help:hover + .tip,
    .label.flex .help:focus + .tip{ display:block; }

    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .row > *{flex:1}

    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:none; background:linear-gradient(180deg,var(--accent),#117a8c);
      color:white; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer
    }
    .btn.secondary{background:#e9f4f6; color:#0b2529; border:1px solid rgba(0,0,0,.08)}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .status{margin-top:8px; min-height:20px; font-size:12px; color:#5a6a6f}
    .status.error{color:#b00020}

    .result-wrap{
      margin-top:14px;
      display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;
    }
    #result{
      font-weight:700; letter-spacing:.2px;
    }

    .note{font-size:12px; color:#5a6a6f; margin-top:6px}

    /* Dock — EXACT match to index.html */
    .dock{
      position:fixed; left:0; right:0; bottom:30px; height:var(--dock-h);
      display:flex; align-items:center; justify-content:center; padding:0 16px; z-index:40;
      pointer-events:none;
    }
    .dock-inner{
      pointer-events:auto;
      display:flex; gap:14px; padding:14px 16px;
      border-radius: 50px;
      background:linear-gradient(180deg, rgba(250,254,255,.70), rgba(250,254,255,.42));
      border:1px solid rgba(255,255,255,.55);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
    }
    .tab{
      appearance:none; border:none; text-decoration:none; cursor:pointer; user-select:none;
      background:
        radial-gradient(120% 160% at 50% -40%, rgba(20,155,178,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.75));
      border:1px solid rgba(255,255,255,.7);
      color:#12343b; font-weight:700; letter-spacing:.2px;
      padding:12px 18px; min-width:200px; text-align:center; border-radius:var(--radius);
      transition: transform .15s ease;
    }
    .tab:hover{ transform: translateY(-2px);}
    .tab:focus-visible{ outline: none; box-shadow: 0 0 0 5px var(--ring);}
    @media (max-width:720px){ .tab{min-width:unset; font-size:14px; padding:10px 14px} }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header" role="banner">
    <img src="logo.png" alt="Vivarch logo" />
  </header>

  <!-- Title -->
  <div class="hub-title">Vivarch Tools Hub</div>

  <!-- Stage -->
  <main class="container" role="main">
    <section class="stage" aria-live="polite">
      <div class="wrap">
        <div class="card">
          <h1>URL Shortening Service</h1>

          <!-- API token field with help tooltip -->
          <div class="field">
            <div class="label flex">
              <span>TinyURL API token</span>
              <span class="help" tabindex="0" aria-label="How to get a TinyURL API token">?</span>
              <div class="tip">
                <strong>Get your TinyURL API token</strong>
                <ol style="margin:8px 0 0 18px; padding:0">
                  <li>Sign in (or create an account) at tinyurl.com.</li>
                  <li>Go to <em>Account → Developer → API</em> (API Tokens).</li>
                  <li>Create a token, then copy it.</li>
                </ol>
                <div style="margin-top:8px">
                  <strong>Use it here:</strong> paste the token into the box below. It’s stored only in your browser (localStorage).
                </div>
              </div>
            </div>
            <input id="apiToken" type="password" placeholder="Paste your TinyURL API token">
          </div>

          <div class="field">
            <label class="label" for="longUrl">Long URL</label>
            <input id="longUrl" type="text" placeholder="Paste a long link (e.g. https://example.com/page?x=1)" />
          </div>

          <div class="row">
            <div class="field">
              <label class="label" for="domain">Domain</label>
              <select id="domain">
                <option value="tinyurl.com" selected>tinyurl.com</option>
                <option value="tiny.one">tiny.one</option>
              </select>
            </div>
            <div class="field">
              <label class="label" for="alias">Custom alias (optional)</label>
              <input id="alias" type="text" placeholder="e.g. vivarch-welcome" />
            </div>
          </div>

          <div class="actions">
            <button id="shorten" class="btn">Shorten URL</button>
            <button id="copy" class="btn secondary" disabled>Copy</button>
            <button id="reset" class="btn secondary">Reset</button>
          </div>

          <div id="status" class="status"></div>

          <div class="result-wrap">
            <input id="result" type="text" placeholder="Short link will appear here" readonly />
            <button id="open" class="btn secondary" disabled>Open</button>
          </div>

          <div class="note">Uses TinyURL API. We’ll auto-add <code>https://</code> if you paste a bare domain. Your API token is never sent anywhere except to TinyURL from your browser.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Dock -->
  <nav class="dock" role="navigation" aria-label="Primary">
    <div class="dock-inner">
      <a class="tab" href="zone-allocation.html">Zone Allocation Search</a>
      <a class="tab" href="qr-code-generator.html">QR Code Generator</a>
      <a class="tab" href="url-shortening-service.html">URL Shortening Service</a>
    </div>
  </nav>

  <script>
    // ====== Config ======
    const TINY_API = 'https://api.tinyurl.com/create';

    // ====== Helpers ======
    function normalizeUrlLike(input){
      let s = (input || '').trim();
      if(!s) return s;
      const lower = s.toLowerCase();
      if (lower.startsWith('http://') || lower.startsWith('https://')) return s;
      if (s.startsWith('www.')) return 'https://' + s;
      if (!s.includes(' ') && s.includes('.') && !s.includes('://')) return 'https://' + s;
      return s;
    }
    function setStatus(msg, isError=false){
      const el = document.getElementById('status');
      el.textContent = msg || '';
      el.classList.toggle('error', !!isError);
    }
    function getToken(){
      const v = (document.getElementById('apiToken').value || '').trim();
      return v || localStorage.getItem('tinyurl_api_token') || '';
    }
    function rememberToken(){
      const v = (document.getElementById('apiToken').value || '').trim();
      if (v){ localStorage.setItem('tinyurl_api_token', v); }
    }
    function applyInvalid(el){
      el.classList.add('invalid');
      setTimeout(()=>el.classList.remove('invalid'), 1200);
    }
    // Scramble reveal for result
    let scrambleTimer=null;
    function scrambleTo(inputEl, finalText, totalMs = 2000, fps = 24){
      clearInterval(scrambleTimer);
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:/._-?=&%#";
      const frameMs = Math.max(16, Math.round(1000 / fps));
      const steps = Math.max(finalText.length * 2, Math.ceil(totalMs / frameMs));
      let tick = 0;
      scrambleTimer = setInterval(() => {
        tick++;
        const reveal = Math.floor(finalText.length * (tick/steps));
        let out = finalText.slice(0,reveal);
        for(let i=reveal;i<finalText.length;i++){
          out += chars[(Math.random()*chars.length)|0];
        }
        inputEl.value = out;
        if(tick>=steps){ clearInterval(scrambleTimer); inputEl.value = finalText; }
      }, frameMs);
    }

    // ====== Main logic ======
    async function shorten(){
      const token = getToken();
      const tokenEl = document.getElementById('apiToken');
      if (!token){
        setStatus('Paste your TinyURL API token first (click the ? for a quick guide).', true);
        applyInvalid(tokenEl);
        tokenEl.focus();
        return;
      }

      const longEl = document.getElementById('longUrl');
      const domainEl = document.getElementById('domain');
      const aliasEl = document.getElementById('alias');
      const resultEl = document.getElementById('result');
      const copyBtn = document.getElementById('copy');
      const openBtn = document.getElementById('open');

      let url = normalizeUrlLike(longEl.value);
      const domain = (domainEl.value || 'tinyurl.com').trim();
      const alias = (aliasEl.value || '').trim();

      resultEl.value = '';
      copyBtn.disabled = true;
      openBtn.disabled = true;

      if (!url){
        setStatus('Please enter a URL.', true);
        applyInvalid(longEl);
        longEl.focus();
        return;
      }

      setStatus('Contacting TinyURL…');
      document.getElementById('shorten').disabled = true;

      try{
        const payload = { url, domain };
        if (alias) payload.alias = alias;

        const res = await fetch(TINY_API, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok){
          const txt = await res.text().catch(()=> '');
          setStatus('TinyURL error: ' + (txt || res.status), true);
          document.getElementById('shorten').disabled = false;
          return;
        }

        const data = await res.json();
        const tiny = data?.data?.tiny_url;

        if (tiny){
          scrambleTo(resultEl, tiny, 1600, 24);
          setTimeout(()=>{
            copyBtn.disabled = false;
            openBtn.disabled = false;
            setStatus('Done. Short link ready.');
            document.getElementById('shorten').disabled = false;
          }, 1650);
        } else {
          const msg = (data?.errors && data.errors[0]?.message) || 'Unexpected response from API.';
          setStatus(msg, true);
          document.getElementById('shorten').disabled = false;
        }
      } catch (e){
        console.error(e);
        setStatus('Network/API error. Please try again.', true);
        document.getElementById('shorten').disabled = false;
      }
    }

    function copyResult(){
      const resultEl = document.getElementById('result');
      if (!resultEl.value) return;
      navigator.clipboard.writeText(resultEl.value)
        .then(()=> setStatus('Copied to clipboard.'))
        .catch(()=> setStatus('Copy failed. You can copy manually.', true));
    }
    function openResult(){
      const v = document.getElementById('result').value;
      if (v) window.open(v, '_blank', 'noopener,noreferrer');
    }
    function resetForm(){
      document.getElementById('longUrl').value = '';
      document.getElementById('alias').value = '';
      document.getElementById('result').value = '';
      document.getElementById('copy').disabled = true;
      document.getElementById('open').disabled = true;
      setStatus('');
    }

    // Wire events
    document.getElementById('shorten').addEventListener('click', shorten);
    document.getElementById('copy').addEventListener('click', copyResult);
    document.getElementById('open').addEventListener('click', openResult);
    document.getElementById('reset').addEventListener('click', resetForm);
    document.getElementById('apiToken').addEventListener('change', rememberToken);

    // Prefill token from localStorage if available
    (function(){
      const saved = localStorage.getItem('tinyurl_api_token');
      if (saved) document.getElementById('apiToken').value = saved;
    })();

    // Enter key in URL field triggers shorten
    document.getElementById('longUrl').addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') shorten();
    });
  </script>
</body>
</html>
